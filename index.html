<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="./assets/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <script src="./assets/js/bootstrap.min.js"></script>
</head>
<body>
    <div class="app">
        <div style="max-width: 400px; margin: 50px auto; padding: 20px; box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);">
            <h2>Đăng nhập</h2>
            <form id="loginForm">
                <div class="form-group">
                    <label class="form-label" for="username">Tên người dùng:</label>
                    <input type="text" id="username" class="form-control">
                </div>
                <div class="form-group">
                    <label class="form-label" for="password">Mật khẩu:</label>
                    <input type="password" id="password" class="form-control">
                </div>
                <button class="btn btn-primary w-100 mt-3" type="submit" >Đăng nhập</button>
            </form>
        </div>
    </div>
    <script src="./assets/js/cryptojs.min.js"></script>
    <script>
        $(document).ready(function () {
            $('#loginForm').on('submit', function (e) {
                e.preventDefault();
                
                const user = $('#username').val();
                const password = $('#password').val();
                const hashedPassword = CryptoJS.SHA1(password + "@1B2c3D4e5F6g7H8").toString();

                checkRoleUser(user, hashedPassword);
            });

            function checkRoleUser(user_id, password) {
                const d = {
                    Uid: user_id,
                    p: password,
                    ip: '0.0.0.0',
                    a: '6fba9a59-46f1-42e6-baea-b2479fa1eb3b'
                };
                
                const Url = 'https://DEV.HOMEOS.vn/service/service.svc/';
                const baseURL = `${Url}GetSessionId?&&`;
                const urlWithParams = `${baseURL}${serializeParams(d)}`;

                $.ajax({
                    url: Url + "GetSessionId?callback=?",
                    type: "GET",
                    dataType: "jsonp",
                    data: d,
                    contentType: "application/json; charset=utf-8",
                    success: function (msg) {
                        let state = JSON.parse(msg);
                        
                        if (state && state.StateId !== "LOGIN_FAIL" && state.StateId !== "TOKEN_NOT_ACTIVED" && state.StateId !== "-1") {
                            localStorage.setItem("UUIDTOKEN_PRINT", state[0].StateId);
                            localStorage.setItem("USERID", user_id);
                            toastr.success('Login successful! Redirecting to homepage in 3 seconds...');
                            setTimeout(function () {
                                window.location.href = "/homePage.html";
                            }, 3000);
                        } else {
                            toastr.error(state.StateName);
                        }
                    },
                    complete: function (data) {

                    },
                    error: function (e, t, x) {
                        // HomeOS.Login.SetActionControl(true);
                        // HomeOS.Login.ShowLabel('Lỗi dữ liệu');
                    }
                });
            }

            function checkRoleUserhhh(user_id, password) {
                const d = {
                    Uid: user_id,
                    p: password,
                    ip: '0.0.0.0',
                    a: '6fba9a59-46f1-42e6-baea-b2479fa1eb3b'
                };
                
                const Url = 'https://DEV.HOMEOS.vn/service/service.svc/';
                const baseURL = `${Url}GetSessionId?&&`;
                const urlWithParams = `${baseURL}${serializeParams(d)}`;

                $.ajax({
                    url: Url + "GetDm?callback=?",
                    type: "GET",
                    dataType: "jsonp",
                    data: d,
                    contentType: "application/json; charset=utf-8",
                    success: function (msg) {
                        let state = JSON.parse(msg);
                        if (state && state.StateId !== "LOGIN_FAIL" && state.StateId !== "TOKEN_NOT_ACTIVED" && state.StateId !== "-1") {
                            localStorage.setItem("UUIDTOKEN_PRINT", state[0].StateId);
                            localStorage.setItem("USERID", user_id);
                            toastr.success('Login successful! Redirecting to homepage in 3 seconds...');
                            setTimeout(function () {
                                const currentDomain = window.location.origin;  // Lấy phần domain hiện tại (VD: https://example.com)
                                const customPath = "/homePage.html";
                                window.location.href = currentDomain + customPath;
                            }, 3000);
                        } else {
                            toastr.error(state.StateName);
                        }
                    },
                    complete: function (data) {

                    },
                    error: function (e, t, x) {
                        // HomeOS.Login.SetActionControl(true);
                        // HomeOS.Login.ShowLabel('Lỗi dữ liệu');
                    }
                });
            }

            function serializeParams(obj) {
                return Object.keys(obj)
                    .map(k => encodeURIComponent(k) + '=' + encodeURIComponent(obj[k]))
                    .join('&');
            }
        });
    </script>
</body>
</html>